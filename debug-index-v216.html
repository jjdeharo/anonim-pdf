<!DOCTYPE html><html lang="es"><head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Anonimizar PDF (rectángulos) — cliente</title>
  <style>
    :root { color-scheme: light dark; }
    * { box-sizing: border-box; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial, "Apple Color Emoji", "Segoe UI Emoji"; margin: 0; }
    header { position: sticky; top: 0; padding: .75rem 1rem; border-bottom: 1px solid #8883; backdrop-filter: blur(6px); }
    main { display: grid; grid-template-columns: 360px 1fr; gap: 1rem; padding: 1rem; }
    @media (max-width: 900px){ main { grid-template-columns: 1fr; } }
    .panel { border: 1px solid #8884; border-radius: .75rem; padding: .75rem; }
    .row { display: flex; gap: .5rem; flex-wrap: wrap; align-items: center; }
    button, input[type="number"], input[type="file"], select { padding: .5rem .6rem; border-radius: .5rem; border: 1px solid #8884; background: inherit; }
    button { cursor: pointer; }
    .muted { opacity: .8; font-size: .92rem; }
    .kbd { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; background: #8882; border: 1px solid #8884; padding: 0 .35rem; border-radius: .35rem; }
    #viewerContainer { position: relative; overflow-y: auto; max-height: 75vh; padding: .5rem; }
    #pagesContainer { display: flex; flex-direction: column; gap: 1.5rem; align-items: center; }
    .pageView { position: relative; }
    .pageView canvas { display: block; border: 1px solid #8884; border-radius: .5rem; background: #fff; }
    .pageView .pdfOverlay { position: absolute; inset: 0; pointer-events: auto; border-radius: .5rem; }
    .pageView.active { outline: 2px solid #3b82f6; outline-offset: 6px; }
    .badget { font-size: .85rem; opacity: .8; }
    footer { padding: .75rem 1rem; border-top: 1px solid #8883; }
    .status { display:inline-flex; gap:.5rem; align-items:center; padding:.25rem .5rem; border:1px solid #8884; border-radius:.5rem; }
    .ok { color: #0a0; }
    .fail { color: #a00; }
  </style>
  <!-- Bibliotecas locales para funcionar sin conexión -->
  <script src="./vendor/pdfjs/pdf.v216.min.js" defer=""></script>
  <script src="./vendor/jspdf/jspdf.umd.min.js" defer=""></script>
<script src="./vendor/pdfjs/pdf.worker.v216.min.js"></script></head>
<body>
  <header class="row">
    <strong>Anonimizar PDF por rectángulos (100% local)</strong>
    <span class="badget">Privado: no sube el archivo a ningún servidor</span>
  </header>

  <main>
    <section class="panel">
      <div class="row" style="margin-bottom:.5rem">
        <input id="file" type="file" accept="application/pdf">
        <button id="btnSample" type="button">Cargar PDF de prueba</button>
        <button id="btnClearRects" disabled="">Limpiar rectángulos de esta página</button>
      </div>
      <div class="row" style="margin-bottom:.5rem; justify-content:flex-start">
        <div><span>Página visible </span><span id="pageNum">1</span><span> / </span><span id="pageCount">17</span></div>
      </div>
      <div class="row" style="margin-bottom:.5rem">
        <label>Grosor del borde: <input id="strokeW" type="number" min="1" max="8" value="2" style="width:4.5rem"></label>
        <label>Opacidad tapa: <input id="opacity" type="number" min="0.1" max="1" step="0.1" value="1" style="width:4.5rem"></label>
        <select id="maskColor" title="Color de la máscara">
          <option value="#000000" selected="">Negro</option>
          <option value="#ffffff">Blanco</option>
          <option value="#888888">Gris</option>
        </select>
      </div>
      <div class="row" style="margin-bottom:.5rem">
        <button id="export">Exportar PDF anonimizado</button>
        <a id="dlLink" download="" style="display:none"></a>
      </div>
      <p class="muted">
        Uso: arrastra con el ratón para definir rectángulos sobre el nombre. Mantén <span class="kbd">Shift</span> para mover el último rectángulo mientras arrastras. Doble clic borra el último rectángulo.
      </p>

      <details>
        <summary>Notas sobre seguridad del anonimizado</summary>
        <ul>
          <li>La exportación genera un PDF de imágenes (rasterizado). El texto original desaparece: ya no es seleccionable ni extraíble como texto.</li>
          <li>Esto es adecuado para ocultar nombres propios de trabajos entregados, con la contrapartida de mayor tamaño y pérdida de accesibilidad.</li>
        </ul>
      </details>

      <details>
        <summary>Pruebas rápidas</summary>
        <div class="row">
          <span class="status">pdf.js: <strong id="stPdfjs" class="ok">cargado</strong></span>
          <span class="status">worker: <strong id="stWorker" class="ok">configurado</strong></span>
          <button id="btnSelfTest" type="button">Autotest</button>
        </div>
        <p class="muted">El autotest carga un PDF de ejemplo, dibuja un rectángulo y permite exportar para verificar que todo funciona.</p>
      </details>
    </section>

    <section class="panel">
      <div id="viewerContainer">
        <div id="pagesContainer"><div class="pageView active" data-page="1" style="width: 795.6px; height: 1029.6px;"><canvas class="pdfPage" width="795" height="1029" style="width: 795.6px; height: 1029.6px;"></canvas><canvas class="pdfOverlay" width="795" height="1029" style="width: 795.6px; height: 1029.6px;"></canvas></div><div class="pageView" data-page="2" style="width: 795.6px; height: 1029.6px;"><canvas class="pdfPage" width="795" height="1029" style="width: 795.6px; height: 1029.6px;"></canvas><canvas class="pdfOverlay" width="795" height="1029" style="width: 795.6px; height: 1029.6px;"></canvas></div><div class="pageView" data-page="3" style="width: 795.6px; height: 1029.6px;"><canvas class="pdfPage" width="795" height="1029" style="width: 795.6px; height: 1029.6px;"></canvas><canvas class="pdfOverlay" width="795" height="1029" style="width: 795.6px; height: 1029.6px;"></canvas></div><div class="pageView" data-page="4" style="width: 795.6px; height: 1029.6px;"><canvas class="pdfPage" width="795" height="1029" style="width: 795.6px; height: 1029.6px;"></canvas><canvas class="pdfOverlay" width="795" height="1029" style="width: 795.6px; height: 1029.6px;"></canvas></div><div class="pageView" data-page="5" style="width: 795.6px; height: 1029.6px;"><canvas class="pdfPage" width="795" height="1029" style="width: 795.6px; height: 1029.6px;"></canvas><canvas class="pdfOverlay" width="795" height="1029" style="width: 795.6px; height: 1029.6px;"></canvas></div><div class="pageView" data-page="6" style="width: 795.6px; height: 1029.6px;"><canvas class="pdfPage" width="795" height="1029" style="width: 795.6px; height: 1029.6px;"></canvas><canvas class="pdfOverlay" width="795" height="1029" style="width: 795.6px; height: 1029.6px;"></canvas></div><div class="pageView" data-page="7" style="width: 795.6px; height: 1029.6px;"><canvas class="pdfPage" width="795" height="1029" style="width: 795.6px; height: 1029.6px;"></canvas><canvas class="pdfOverlay" width="795" height="1029" style="width: 795.6px; height: 1029.6px;"></canvas></div><div class="pageView" data-page="8" style="width: 795.6px; height: 1029.6px;"><canvas class="pdfPage" width="795" height="1029" style="width: 795.6px; height: 1029.6px;"></canvas><canvas class="pdfOverlay" width="795" height="1029" style="width: 795.6px; height: 1029.6px;"></canvas></div><div class="pageView" data-page="9" style="width: 795.6px; height: 1029.6px;"><canvas class="pdfPage" width="795" height="1029" style="width: 795.6px; height: 1029.6px;"></canvas><canvas class="pdfOverlay" width="795" height="1029" style="width: 795.6px; height: 1029.6px;"></canvas></div><div class="pageView" data-page="10" style="width: 795.6px; height: 1029.6px;"><canvas class="pdfPage" width="795" height="1029" style="width: 795.6px; height: 1029.6px;"></canvas><canvas class="pdfOverlay" width="795" height="1029" style="width: 795.6px; height: 1029.6px;"></canvas></div><div class="pageView" data-page="11" style="width: 795.6px; height: 1029.6px;"><canvas class="pdfPage" width="795" height="1029" style="width: 795.6px; height: 1029.6px;"></canvas><canvas class="pdfOverlay" width="795" height="1029" style="width: 795.6px; height: 1029.6px;"></canvas></div><div class="pageView" data-page="12" style="width: 795.6px; height: 1029.6px;"><canvas class="pdfPage" width="795" height="1029" style="width: 795.6px; height: 1029.6px;"></canvas><canvas class="pdfOverlay" width="795" height="1029" style="width: 795.6px; height: 1029.6px;"></canvas></div><div class="pageView" data-page="13" style="width: 795.6px; height: 1029.6px;"><canvas class="pdfPage" width="795" height="1029" style="width: 795.6px; height: 1029.6px;"></canvas><canvas class="pdfOverlay" width="795" height="1029" style="width: 795.6px; height: 1029.6px;"></canvas></div><div class="pageView" data-page="14" style="width: 795.6px; height: 1029.6px;"><canvas class="pdfPage" width="795" height="1029" style="width: 795.6px; height: 1029.6px;"></canvas><canvas class="pdfOverlay" width="795" height="1029" style="width: 795.6px; height: 1029.6px;"></canvas></div><div class="pageView" data-page="15" style="width: 795.6px; height: 1029.6px;"><canvas class="pdfPage" width="795" height="1029" style="width: 795.6px; height: 1029.6px;"></canvas><canvas class="pdfOverlay" width="795" height="1029" style="width: 795.6px; height: 1029.6px;"></canvas></div><div class="pageView" data-page="16" style="width: 795.6px; height: 1029.6px;"><canvas class="pdfPage" width="795" height="1029" style="width: 795.6px; height: 1029.6px;"></canvas><canvas class="pdfOverlay" width="795" height="1029" style="width: 795.6px; height: 1029.6px;"></canvas></div><div class="pageView" data-page="17" style="width: 795.6px; height: 1029.6px;"><canvas class="pdfPage" width="795" height="1029" style="width: 795.6px; height: 1029.6px;"></canvas><canvas class="pdfOverlay" width="795" height="1029" style="width: 795.6px; height: 1029.6px;"></canvas></div></div>
      </div>
    </section>
  </main>

  <footer class="muted">
    Hecho con pdf.js (legacy build) y jsPDF. Uso totalmente local en tu navegador.
  </footer>

<script>
  window.addEventListener('DOMContentLoaded', () => {
    const havePdfjs = typeof window.pdfjsLib !== 'undefined';
    const stPdfjs = document.getElementById('stPdfjs');
    const stWorker = document.getElementById('stWorker');
    if (havePdfjs) { stPdfjs.textContent = 'cargado'; stPdfjs.className = 'ok'; }
    else { stPdfjs.textContent = 'no cargado'; stPdfjs.className = 'fail'; }

    if (!havePdfjs) {
      alert('No se pudo cargar pdf.js. Comprueba la conexión o políticas de bloqueadores. He cambiado al build legacy para exponer "pdfjsLib".');
      return;
    }

    const WORKER_SRC = './vendor/pdfjs/pdf.worker.v216.min.js';
    try {
      pdfjsLib.GlobalWorkerOptions.workerSrc = WORKER_SRC;
    } catch (err) {
      console.warn('Fallo al configurar worker pdf.js, usando modo sin worker.', err);
      pdfjsLib.disableWorker = true;
    }
    stWorker.textContent = 'configurado'; stWorker.className = 'ok';

    const viewerContainer = document.getElementById('viewerContainer');
    const pagesContainer = document.getElementById('pagesContainer');
    const fileInput = document.getElementById('file');
    const btnSample = document.getElementById('btnSample');
    const btnSelfTest = document.getElementById('btnSelfTest');
    const pageNumEl = document.getElementById('pageNum');
    const pageCountEl = document.getElementById('pageCount');
    const btnExport = document.getElementById('export');
    const btnClearRects = document.getElementById('btnClearRects');
    const opacityEl = document.getElementById('opacity');
    const strokeWEl = document.getElementById('strokeW');
    const maskColorEl = document.getElementById('maskColor');

    let pdfDoc = null;
    let scale = 1;
    let rectsByPage = {};
    let activePage = 1;
    const pageViews = new Map();
    const pageStates = new Map();

    const observer = 'IntersectionObserver' in window
      ? new IntersectionObserver((entries) => {
          let nextPage = activePage;
          let maxRatio = 0;
          for (const entry of entries) {
            if (entry.isIntersecting && entry.intersectionRatio > maxRatio) {
              nextPage = Number(entry.target.dataset.page);
              maxRatio = entry.intersectionRatio;
            }
          }
          if (nextPage !== activePage && pageViews.has(nextPage)) {
            setActivePage(nextPage);
          }
        }, { root: viewerContainer, threshold: [0.2, 0.45, 0.7] })
      : null;

    fileInput.addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const arrayBuf = await file.arrayBuffer();
      await loadPdfFromArrayBuffer(arrayBuf);
    });

    btnClearRects.addEventListener('click', () => {
      if (!pdfDoc) return;
      rectsByPage[activePage] = [];
      drawOverlay(activePage);
      updateClearButtonState();
    });

    maskColorEl.addEventListener('change', redrawAllOverlays);
    opacityEl.addEventListener('change', redrawAllOverlays);
    strokeWEl.addEventListener('change', redrawAllOverlays);

    document.getElementById('export').addEventListener('click', async () => {
      if (!pdfDoc) return;
      const { jsPDF } = window.jspdf;
      const pdfOut = new jsPDF({ unit: 'pt', compress: true });

      for (let p = 1; p <= pdfDoc.numPages; p++) {
        const page = await pdfDoc.getPage(p);
        const viewport = page.getViewport({ scale });

        const pageCanvas = document.createElement('canvas');
        pageCanvas.width = viewport.width; pageCanvas.height = viewport.height;
        const pctx = pageCanvas.getContext('2d');
        await page.render({ canvasContext: pctx, viewport }).promise;

        const maskCanvas = document.createElement('canvas');
        maskCanvas.width = viewport.width; maskCanvas.height = viewport.height;
        const mctx = maskCanvas.getContext('2d');
        const rects = rectsByPage[p] || [];
        const mask = maskColorEl.value || '#000';
        const alpha = Math.max(0.1, Math.min(1, Number(opacityEl.value) || 1));
        mctx.save();
        for (const r of rects) {
          mctx.globalAlpha = alpha;
          mctx.fillStyle = mask;
          mctx.fillRect(r.x, r.y, r.w, r.h);
        }
        mctx.restore();

        pctx.drawImage(maskCanvas, 0, 0);

        const img = pageCanvas.toDataURL('image/jpeg', 0.92);
        if (p > 1) pdfOut.addPage([viewport.width, viewport.height]);
        pdfOut.setPage(p);
        pdfOut.addImage(img, 'JPEG', 0, 0, viewport.width, viewport.height, undefined, 'FAST');
      }

      const blob = pdfOut.output('blob');
      const url = URL.createObjectURL(blob);
      const a = document.getElementById('dlLink');
      a.href = url; a.download = 'pdf_anonimizado.pdf';
      a.textContent = 'Descargar PDF anonimizado';
      a.style.display = 'inline';
      a.click();
    });

    btnSample.addEventListener('click', async () => {
      const buf = await makeSamplePdfArrayBuffer();
      await loadPdfFromArrayBuffer(buf);
    });

    btnSelfTest.addEventListener('click', async () => {
      try {
        const buf = await makeSamplePdfArrayBuffer();
        await loadPdfFromArrayBuffer(buf);
        rectsByPage[1] = [{ x: 40, y: 40, w: 260, h: 36 }];
        drawOverlay(1);
        setActivePage(1);
        updateClearButtonState();
        document.getElementById('export').click();
      } catch (e) {
        alert('Autotest fallido: ' + (e && e.message ? e.message : e));
      }
    });

    async function loadPdfFromArrayBuffer(arrayBuf) {
      const loadingTask = pdfjsLib.getDocument({
        data: arrayBuf,
        cMapUrl: './vendor/pdfjs/cmaps/',
        cMapPacked: true,
        standardFontDataUrl: './vendor/pdfjs/standard_fonts/'
      });
      pdfDoc = await loadingTask.promise;
      rectsByPage = {};
      pageViews.clear();
      pageStates.clear();
      observer?.disconnect();
      pagesContainer.innerHTML = '';

      const firstPage = await pdfDoc.getPage(1);
      const baseViewport = firstPage.getViewport({ scale: 1 });
      scale = computeScaleForWidth(baseViewport.width);

      await renderPage(1, firstPage);
      for (let p = 2; p <= pdfDoc.numPages; p++) {
        await renderPage(p);
      }

      pageCountEl.textContent = pdfDoc.numPages;
      setActivePage(1);
      updateClearButtonState();
      btnExport.disabled = false;
    }

    async function renderPage(pageNumber, pageInstance) {
      const page = pageInstance || await pdfDoc.getPage(pageNumber);
      const viewport = page.getViewport({ scale });
      let view = pageViews.get(pageNumber);
      if (!view) {
        view = createPageView(pageNumber);
      }

      const { canvas, overlay, ctx, octx, wrapper } = view;
      const width = viewport.width;
      const height = viewport.height;
      canvas.width = width; canvas.height = height;
      overlay.width = width; overlay.height = height;
      canvas.style.width = overlay.style.width = width + 'px';
      canvas.style.height = overlay.style.height = height + 'px';
      wrapper.style.width = width + 'px';
      wrapper.style.height = height + 'px';

      await page.render({ canvasContext: ctx, viewport }).promise;
      drawOverlay(pageNumber);
    }

    function createPageView(pageNumber) {
      const wrapper = document.createElement('div');
      wrapper.className = 'pageView';
      wrapper.dataset.page = String(pageNumber);

      const canvas = document.createElement('canvas');
      canvas.className = 'pdfPage';

      const overlay = document.createElement('canvas');
      overlay.className = 'pdfOverlay';

      wrapper.append(canvas, overlay);
      pagesContainer.appendChild(wrapper);
      observer?.observe(wrapper);

      const view = {
        wrapper,
        canvas,
        overlay,
        ctx: canvas.getContext('2d'),
        octx: overlay.getContext('2d')
      };

      setupOverlayInteractions(pageNumber, view);
      pageViews.set(pageNumber, view);
      return view;
    }

    function setupOverlayInteractions(pageNumber, view) {
      const { overlay } = view;
      overlay.addEventListener('mousedown', (e) => {
        e.preventDefault();
        const state = getPageState(pageNumber);
        const { x, y } = getMousePos(e, overlay);
        state.drawing = true;
        state.startX = x;
        state.startY = y;
        state.previewRect = null;
        setActivePage(pageNumber);
      });

      overlay.addEventListener('mousemove', (e) => {
        const state = getPageState(pageNumber);
        if (!state.drawing) return;
        const { x, y } = getMousePos(e, overlay);
        if (e.shiftKey && state.previewRect) {
          const rect = state.previewRect;
          const dx = x - (rect.x + rect.w / 2);
          const dy = y - (rect.y + rect.h / 2);
          rect.x += dx;
          rect.y += dy;
        } else {
          state.previewRect = normalizeRect(state.startX, state.startY, x, y);
        }
        drawOverlay(pageNumber);
      });

      const endDrawing = () => {
        const state = getPageState(pageNumber);
        if (!state.drawing) return;
        state.drawing = false;
        if (!rectsByPage[pageNumber]) rectsByPage[pageNumber] = [];
        const rect = state.previewRect;
        if (rect && rect.w > 4 && rect.h > 4) {
          rectsByPage[pageNumber].push({ ...rect });
        }
        state.previewRect = null;
        drawOverlay(pageNumber);
        updateClearButtonState();
      };

      overlay.addEventListener('mouseup', endDrawing);
      overlay.addEventListener('mouseleave', endDrawing);

      overlay.addEventListener('dblclick', () => {
        const list = rectsByPage[pageNumber] || [];
        list.pop();
        rectsByPage[pageNumber] = list;
        drawOverlay(pageNumber);
        updateClearButtonState();
      });
    }

    function getPageState(pageNumber) {
      if (!pageStates.has(pageNumber)) {
        pageStates.set(pageNumber, { drawing: false, startX: 0, startY: 0, previewRect: null });
      }
      return pageStates.get(pageNumber);
    }

    function drawOverlay(pageNumber) {
      const view = pageViews.get(pageNumber);
      if (!view) return;
      const { overlay, octx } = view;
      octx.clearRect(0, 0, overlay.width, overlay.height);
      const mask = maskColorEl.value || '#000';
      const alpha = Math.max(0.1, Math.min(1, Number(opacityEl.value) || 1));
      const strokeW = Number(strokeWEl.value) || 2;
      const rects = rectsByPage[pageNumber] || [];
      const preview = pageStates.get(pageNumber)?.previewRect || null;

      octx.save();
      for (const rect of rects) paintRect(octx, rect, mask, alpha, strokeW);
      if (preview) paintRect(octx, preview, mask, alpha, strokeW);
      octx.restore();
    }

    function paintRect(ctx, rect, mask, alpha, strokeW) {
      ctx.globalAlpha = alpha;
      ctx.fillStyle = mask;
      ctx.fillRect(rect.x, rect.y, rect.w, rect.h);
      ctx.globalAlpha = 1;
      ctx.lineWidth = strokeW;
      ctx.strokeStyle = '#000';
      ctx.strokeRect(rect.x, rect.y, rect.w, rect.h);
    }

    function redrawAllOverlays() {
      for (const pageNumber of pageViews.keys()) {
        drawOverlay(pageNumber);
      }
    }

    function setActivePage(pageNumber) {
      if (!pageViews.has(pageNumber)) return;
      activePage = pageNumber;
      pageNumEl.textContent = pageNumber;
      for (const [num, view] of pageViews.entries()) {
        view.wrapper.classList.toggle('active', num === pageNumber);
      }
      updateClearButtonState();
    }

    function updateClearButtonState() {
      if (!pdfDoc) {
        btnClearRects.disabled = true;
        return;
      }
      const rects = rectsByPage[activePage] || [];
      btnClearRects.disabled = rects.length === 0;
    }

    function computeScaleForWidth(pageWidth) {
      const containerWidth = viewerContainer.clientWidth || viewerContainer.getBoundingClientRect().width;
      if (!containerWidth) return 1;
      const available = Math.max(containerWidth - 24, 200);
      const fitScale = available / pageWidth;
      if (!Number.isFinite(fitScale) || fitScale <= 0) return 1;
      return Math.min(1.3, fitScale);
    }

    function getMousePos(e, el) {
      const rect = el.getBoundingClientRect();
      const x = (e.clientX - rect.left) * (el.width / rect.width);
      const y = (e.clientY - rect.top) * (el.height / rect.height);
      return { x, y };
    }

    function normalizeRect(x1, y1, x2, y2) {
      const x = Math.min(x1, x2);
      const y = Math.min(y1, y2);
      const w = Math.abs(x2 - x1);
      const h = Math.abs(y2 - y1);
      return { x, y, w, h };
    }

    async function makeSamplePdfArrayBuffer() {
      const { jsPDF } = window.jspdf;
      const d = new jsPDF({ unit: 'pt' });
      d.setFontSize(14);
      d.text('Trabajo de biología — 2º Bachillerato', 40, 60);
      d.text('Nombre del alumno: Juan Pérez García', 40, 90);
      d.text('Asignatura: Biología', 40, 120);
      d.text('Tema: Genética mendeliana', 40, 150);
      d.text('Este es un PDF de prueba para tapar el nombre con un rectángulo.', 40, 180, { maxWidth: 500 });
      d.addPage();
      d.text('Segunda página', 40, 60);
      d.text('Nombre del alumno: María López', 40, 90);
      const blob = d.output('blob');
      return await blob.arrayBuffer();
    }
  });
</script>


</body></html>